<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ® - ÙƒØ´Ù Ø­Ø³Ø§Ø¨</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #22c55e; --danger: #ef4444; --warning: #f59e0b; --background: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--background); direction: rtl; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .f-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; color: #475569; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-save { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .hidden { display: none !important; }
        .actions-btns { display: flex; gap: 5px; justify-content: center; }
        .btn-action { border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; color: white; }
        .btn-edit { background: var(--warning); }
        .btn-del { background: var(--danger); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; position: sticky; top: 0; }
        .balance-card { background: #eff6ff; border: 1px solid #bfdbfe; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 25px; }
        .row-batch { background-color: #f0fdf4; font-weight: bold; }
        .error-hint { color: var(--danger); font-size: 0.8rem; font-weight: bold; margin-top: 5px; display: none; }
        
        /* ØªØµÙ…ÙŠÙ… ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© */
        .filter-section {
            background: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .filter-section h4 { margin: 0; color: #92400e; }
        .filter-input { flex-grow: 1; border: 2px solid #f59e0b; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary);">Ù†Ø¸Ø§Ù… Ø§Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ®</h2>

    <div class="balance-card">
        <label>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ²Ø¹</label>
        <div id="displayBal" style="font-size: 2.2rem; font-weight: 900; color: var(--danger);">0</div>
    </div>

    <div class="grid-form">
        <div class="f-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹</label>
            <input type="text" id="name" list="namesList" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹..." oninput="fetchUserLastData()">
            <datalist id="namesList"></datalist>
        </div>

        <div class="f-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="opType" onchange="toggleUI()">
                <option value="Ø·Ø¨Ø¹Ø©">ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… ÙØ±ÙˆØ®</option>
                <option value="Ø¯ÙØ¹Ø©">ğŸ’° ØªØ³Ø¯ÙŠØ¯ Ø¯ÙØ¹Ø©</option>
            </select>
        </div>

        <div class="f-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="opDate"></div>
        <div class="f-group batch-only"><label>Ø±Ù‚Ù… Ø§Ù„Ø·Ø¨Ø¹Ø©</label><input type="number" id="batch" value="0"></div>
        <div class="f-group batch-only"><label>Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆØ®</label><input type="number" id="qty" oninput="runCalc()" value="0" step="0.5"></div>
        <div class="f-group batch-only"><label>Ø³Ø¹Ø± Ø§Ù„ÙØ±Ø®</label><input type="number" id="price" oninput="runCalc()" value="90"></div>
        
        <div class="f-group"><label>Ø¯ÙŠÙ† Ø³Ø§Ø¨Ù‚</label><input type="number" id="oldDebt" oninput="runCalc()" value="0"></div>
        
        <div class="f-group pay-only hidden">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
            <input type="number" id="paid" oninput="runCalc()" value="0">
            <span id="negAlert" class="error-hint">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ†!</span>
        </div>
        
        <div class="f-group">
            <label>ØµØ§ÙÙŠ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
            <input type="number" id="remain" readonly style="background:#fff1f2; font-weight:bold; color:#be123c;">
        </div>
    </div>

    <button id="submitBtn" class="btn-save" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    <button id="cancelEdit" class="hidden" onclick="resetForm()" style="margin-top:10px; width:100%; padding:10px; background:#64748b; color:white; border:none; border-radius:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">

    <div class="filter-section">
        <h4>ğŸ” ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ²Ø¹:</h4>
        <input type="text" id="filterName" list="namesList" class="filter-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹ Ù„ÙÙ„ØªØ±Ø© Ù†ØªØ§Ø¦Ø¬Ù‡..." oninput="refreshUI()">
        <button onclick="document.getElementById('filterName').value=''; refreshUI()" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
    </div>

    <div style="overflow-x:auto; max-height: 500px;">
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…ÙˆØ²Ø¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                    <th>Ø¹Ø¯Ø¯</th>
                    <th>Ø³Ø§Ø¨Ù‚</th>
                    <th>Ù…Ø¯ÙÙˆØ¹</th>
                    <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="mainTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase (Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    const firebaseConfig = {
        apiKey: "AIzaSyDm8VXj0nezKEBTgb22IwBFym_pBju_vFk",
        authDomain: "cards-8397e.firebaseapp.com",
        databaseURL: "https://cards-8397e-default-rtdb.firebaseio.com",
        projectId: "cards-8397e",
        storageBucket: "cards-8397e.firebasestorage.app",
        messagingSenderId: "509372121697",
        appId: "1:509372121697:web:a93b9bd262c764f04c2020"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database().ref('distributors');
    let localDB = [];
    let editingId = null;

    document.getElementById('opDate').valueAsDate = new Date();

    database.on('value', snap => {
        const val = snap.val();
        localDB = val ? Object.entries(val).map(([id, data]) => ({id, ...data})) : [];
        refreshUI();
        updateDatalist();
    });

    function toggleUI() {
        const type = document.getElementById('opType').value;
        const batchFields = document.querySelectorAll('.batch-only');
        const payFields = document.querySelectorAll('.pay-only');
        if (type === 'Ø¯ÙØ¹Ø©') {
            batchFields.forEach(el => el.classList.add('hidden'));
            payFields.forEach(el => el.classList.remove('hidden'));
            document.getElementById('qty').value = 0;
        } else {
            batchFields.forEach(el => el.classList.remove('hidden'));
            payFields.forEach(el => el.classList.add('hidden'));
        }
        runCalc();
    }

    function fetchUserLastData() {
        if (editingId) return; 
        const name = document.getElementById('name').value.trim();
        const userRecords = localDB.filter(r => r.name === name).sort((a,b) => b.ts - a.ts);
        const lastBal = userRecords.length > 0 ? parseFloat(userRecords[0].remain) : 0;
        document.getElementById('oldDebt').value = Math.round(lastBal);
        document.getElementById('displayBal').innerText = Math.round(lastBal);
        runCalc();
    }

    function runCalc() {
        const q = parseFloat(document.getElementById('qty').value) || 0;
        const p = parseFloat(document.getElementById('price').value) || 0;
        const old = parseFloat(document.getElementById('oldDebt').value) || 0;
        const paid = parseFloat(document.getElementById('paid').value) || 0;
        const result = (q * p) + old - paid;
        document.getElementById('remain').value = Math.round(result);
        const negAlert = document.getElementById('negAlert');
        if (result < 0) {
            negAlert.style.display = 'block';
            document.getElementById('remain').style.color = 'orange';
        } else {
            negAlert.style.display = 'none';
            document.getElementById('remain').style.color = '#be123c';
        }
    }

    function saveData() {
        const name = document.getElementById('name').value.trim();
        const type = document.getElementById('opType').value;
        const remainVal = parseFloat(document.getElementById('remain').value);
        if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹");
        if (remainVal < 0) {
            const currentDebt = (parseFloat(document.getElementById('qty').value) * parseFloat(document.getElementById('price').value)) + 
                                parseFloat(document.getElementById('oldDebt').value);
            return alert(`ğŸ›‘ Ø®Ø·Ø£ Ù…Ø­Ø§Ø³Ø¨ÙŠ: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨Ø¶ Ù…Ø¨Ù„Øº (${document.getElementById('paid').value}) Ù„Ø£Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù‡Ùˆ (${currentDebt}) ÙÙ‚Ø·.`);
        }

        let finalTypeLabel = "";
        if (type === "Ø·Ø¨Ø¹Ø©") {
            const batchNum = document.getElementById('batch').value || 0;
            finalTypeLabel = `Ø·Ø¨Ø¹Ø© (${batchNum})`;
        } else {
            const userPayments = localDB.filter(r => r.name === name && r.type.includes("Ø¯ÙØ¹Ø©")).length;
            finalTypeLabel = `Ø¯ÙØ¹Ø© ${userPayments + 1}`;
        }

        const data = {
            name: name,
            type: finalTypeLabel,
            date: document.getElementById('opDate').value,
            batch: document.getElementById('batch').value || 0,
            qty: document.getElementById('qty').value,
            price: document.getElementById('price').value,
            old: Math.round(parseFloat(document.getElementById('oldDebt').value)),
            paid: Math.round(parseFloat(document.getElementById('paid').value)),
            remain: Math.round(remainVal),
            ts: Date.now()
        };

        if (editingId) {
            database.child(editingId).update(data).then(() => { alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…"); resetForm(); });
        } else {
            database.push(data).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); resetForm(); });
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('submitBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
        document.getElementById('cancelEdit').classList.add('hidden');
        document.getElementById('paid').value = 0;
        document.getElementById('qty').value = 0;
        document.getElementById('name').value = "";
        document.getElementById('oldDebt').value = 0;
        document.getElementById('remain').value = 0;
        document.getElementById('displayBal').innerText = 0;
        document.getElementById('opDate').valueAsDate = new Date();
    }

    function editItem(id) {
        const item = localDB.find(r => r.id === id);
        editingId = id;
        document.getElementById('name').value = item.name;
        document.getElementById('opType').value = item.type.includes("Ø·Ø¨Ø¹Ø©") ? "Ø·Ø¨Ø¹Ø©" : "Ø¯ÙØ¹Ø©";
        document.getElementById('opDate').value = item.date;
        document.getElementById('batch').value = item.batch;
        document.getElementById('qty').value = item.qty;
        document.getElementById('price').value = item.price;
        document.getElementById('oldDebt').value = item.old;
        document.getElementById('paid').value = item.paid;
        document.getElementById('submitBtn').innerText = "ğŸ†™ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„";
        document.getElementById('cancelEdit').classList.remove('hidden');
        toggleUI();
        window.scrollTo(0,0);
    }

    function deleteItem(id) {
        if (confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) database.child(id).remove();
    }

    function updateDatalist() {
        const namesList = document.getElementById('namesList');
        const uniqueNames = [...new Set(localDB.map(r => r.name))];
        namesList.innerHTML = uniqueNames.map(n => `<option value="${n}">`).join('');
    }

    function refreshUI() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
        const filterValue = document.getElementById('filterName').value.trim();

        // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        let displayData = localDB;
        if (filterValue !== "") {
            displayData = localDB.filter(r => r.name.includes(filterValue));
        }

        // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ù„Ù„Ø£Ù‚Ø¯Ù… ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        displayData.sort((a,b) => b.ts - a.ts).forEach(item => {
            const isBatch = item.type.includes("Ø·Ø¨Ø¹Ø©");
            tbody.innerHTML += `
                <tr class="${isBatch ? 'row-batch' : 'row-payment'}">
                    <td>${item.name}</td>
                    <td>${item.date}</td>
                    <td>${item.type}</td>
                    <td>${item.qty}</td>
                    <td>${item.old}</td>
                    <td style="color:green;">${item.paid || 0}</td>
                    <td style="color:red; font-weight:bold;">${item.remain}</td>
                    <td class="actions-btns">
                        <button class="btn-action btn-edit" onclick="editItem('${item.id}')">âœï¸</button>
                        <button class="btn-action btn-del" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
        });
    }
</script>
</body>
</html>

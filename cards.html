<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ®</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --main-gradient: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); 
            --bg-color: #f1f5f9;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-color); 
            background-image: radial-gradient(#cbd5e1 0.8px, transparent 0.8px);
            background-size: 24px 24px;
            direction: rtl; padding: 20px; margin: 0; color: #1e293b;
        }

        .container { 
            max-width: 1200px; margin: auto; background: rgba(255, 255, 255, 0.95); 
            padding: 30px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(8px); border: 1px solid #fff;
        }

        h2 { text-align: center; color: #4338ca; font-weight: 800; margin-bottom: 25px; }

        .balance-card { 
            background: var(--main-gradient); color: white; padding: 25px; 
            border-radius: 20px; text-align: center; margin-bottom: 30px; 
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
        }
        
        #displayBal { font-size: 3.2rem; font-weight: 900; line-height: 1; margin-top: 10px; }

        .grid-form { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; margin-bottom: 30px; background: #fff; padding: 25px;
            border-radius: 20px; border: 1px solid #f1f5f9;
        }

        .f-group { display: flex; flex-direction: column; gap: 8px; }
        .f-group label { font-size: 0.85rem; font-weight: 700; color: #64748b; }
        
        input, select { 
            padding: 12px 15px; border: 2px solid #f1f5f9; border-radius: 12px; 
            font-size: 0.95rem; transition: all 0.3s; background: #f8fafc;
            width: 100%; box-sizing: border-box;
        }
        
        input:focus { border-color: #6366f1; background: white; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .btn-save { 
            width: 100%; padding: 18px; background: var(--success-gradient);
            color: white; border: none; border-radius: 16px; font-weight: 800; 
            cursor: pointer; font-size: 1.1rem; transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.25);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.35); }
        .btn-save:disabled { background: #94a3b8; cursor: not-allowed; transform: none; box-shadow: none; }

        .error-msg { color: #e11d48; font-size: 0.75rem; font-weight: bold; margin-top: 4px; display: none; }

        .filter-section {
            margin: 35px 0 20px 0; display: flex; align-items: center; gap: 15px;
            background: #fefce8; padding: 15px 20px; border-radius: 15px; border: 1px solid #fef08a;
        }
        
        .table-wrapper { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .scrollable-table { overflow-x: auto; max-height: 550px; }
        
        table { width: 100%; border-collapse: collapse; min-width: 950px; }
        th { background: #f8fafc; padding: 18px; color: #475569; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #f1f5f9; }
        
        .row-batch { background-color: #f0fdf4 !important; }
        .hidden { display: none !important; }

        .btn-action { border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .btn-edit { background: #fef3c7; color: #d97706; }
        .btn-del { background: #fee2e2; color: #dc2626; }
    </style>
</head>
<body>

<div class="container">
    <h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙØ±ÙˆØ®</h2>

    <div class="balance-card">
        <label style="opacity: 0.9;">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label>
        <div id="displayBal">0</div>
    </div>

    <div class="grid-form">
        <div class="f-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹</label>
            <input type="text" id="name" list="namesList" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..." oninput="fetchUserLastData()">
            <datalist id="namesList"></datalist>
        </div>

        <div class="f-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="opType" onchange="toggleUI()">
                <option value="Ø·Ø¨Ø¹Ø©">ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… ÙØ±ÙˆØ®</option>
                <option value="Ø¯ÙØ¹Ø©">ğŸ’° ØªØ³Ø¯ÙŠØ¯ Ø¯ÙØ¹Ø©</option>
            </select>
        </div>

        <div class="f-group batch-only">
            <label>Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø®</label>
            <select id="chickenType">
                <option value="8 Ø³Ø§Ø¹Ø§Øª">8 Ø³Ø§Ø¹Ø§Øª</option>
                <option value="10 Ø³Ø§Ø¹Ø§Øª">10 Ø³Ø§Ø¹Ø§Øª</option>
                <option value="24 Ø³Ø§Ø¹Ø©">24 Ø³Ø§Ø¹Ø©</option>
            </select>
        </div>

        <div class="f-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="opDate"></div>
        <div class="f-group batch-only"><label>Ø±Ù‚Ù… Ø§Ù„Ø·Ø¨Ø¹Ø©</label><input type="number" id="batch" value="0"></div>
        <div class="f-group batch-only"><label>Ø§Ù„Ø¹Ø¯Ø¯</label><input type="number" id="qty" oninput="runCalc()" value="0" step="0.5"></div>
        <div class="f-group batch-only"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="price" oninput="runCalc()" value="90"></div>
        
        <div class="f-group">
            <label>Ø¯ÙŠÙ† Ø³Ø§Ø¨Ù‚</label>
            <input type="number" id="oldDebt" oninput="runCalc()" value="0" readonly style="background:#f1f5f9;">
            <span id="noDebtHint" class="error-msg">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ²Ø¹ Ø­Ø§Ù„ÙŠØ§Ù‹</span>
        </div>
        
        <div class="f-group pay-only hidden">
            <label>Ù…Ø¯ÙÙˆØ¹</label>
            <input type="number" id="paid" oninput="runCalc()" value="0">
            <span id="payLimitHint" class="error-msg">âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨!</span>
        </div>
        
        <div class="f-group">
            <label>ØµØ§ÙÙŠ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
            <input type="number" id="remain" readonly style="background:#fff1f2; color:#be123c; font-weight: 900;">
        </div>
    </div>

    <button id="submitBtn" class="btn-save" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
    <button id="cancelEdit" class="hidden" onclick="resetForm()" style="margin-top:10px; width:100%; padding:15px; background:#94a3b8; color:white; border:none; border-radius:12px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>

    <div class="filter-section">
        <h4 style="margin:0;">ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨:</h4>
        <input type="text" id="filterName" list="namesList" class="filter-input" style="flex:1" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹..." oninput="refreshUI()">
    </div>

    <div class="table-wrapper">
        <div class="scrollable-table">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…ÙˆØ²Ø¹</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
                        <th>Ø³Ø§Ø¨Ù‚</th> <th>Ù…Ø¯ÙÙˆØ¹</th>
                        <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDm8VXj0nezKEBTgb22IwBFym_pBju_vFk",
        authDomain: "cards-8397e.firebaseapp.com",
        databaseURL: "https://cards-8397e-default-rtdb.firebaseio.com",
        projectId: "cards-8397e",
        storageBucket: "cards-8397e.firebasestorage.app",
        messagingSenderId: "509372121697",
        appId: "1:509372121697:web:a93b9bd262c764f04c2020"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database().ref('distributors');
    let localDB = [];
    let editingId = null;

    document.getElementById('opDate').valueAsDate = new Date();

    database.on('value', snap => {
        const val = snap.val();
        localDB = val ? Object.entries(val).map(([id, data]) => ({id, ...data})) : [];
        refreshUI();
        updateDatalist();
    });

    function toggleUI() {
        const type = document.getElementById('opType').value;
        const batchFields = document.querySelectorAll('.batch-only');
        const payFields = document.querySelectorAll('.pay-only');
        if (type === 'Ø¯ÙØ¹Ø©') {
            batchFields.forEach(el => el.classList.add('hidden'));
            payFields.forEach(el => el.classList.remove('hidden'));
            document.getElementById('qty').value = 0;
        } else {
            batchFields.forEach(el => el.classList.remove('hidden'));
            payFields.forEach(el => el.classList.add('hidden'));
            document.getElementById('noDebtHint').style.display = 'none';
        }
        runCalc();
    }

    function fetchUserLastData() {
        if (editingId) return; 
        const name = document.getElementById('name').value.trim();
        const userRecords = localDB.filter(r => r.name === name).sort((a,b) => b.ts - a.ts);
        const lastBal = userRecords.length > 0 ? parseFloat(userRecords[0].remain) : 0;
        document.getElementById('oldDebt').value = Math.round(lastBal);
        document.getElementById('displayBal').innerText = Math.round(lastBal).toLocaleString();
        runCalc();
    }

    function runCalc() {
        const type = document.getElementById('opType').value;
        const q = parseFloat(document.getElementById('qty').value) || 0;
        const p = parseFloat(document.getElementById('price').value) || 0;
        const old = parseFloat(document.getElementById('oldDebt').value) || 0;
        const paid = parseFloat(document.getElementById('paid').value) || 0;
        
        const currentTotal = (q * p) + old;
        const result = currentTotal - paid;
        document.getElementById('remain').value = Math.round(result);

        const submitBtn = document.getElementById('submitBtn');
        const payLimitHint = document.getElementById('payLimitHint');
        const noDebtHint = document.getElementById('noDebtHint');

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        if (type === 'Ø¯ÙØ¹Ø©') {
            if (old <= 0) {
                noDebtHint.style.display = 'block';
                payLimitHint.style.display = 'none';
                submitBtn.disabled = true;
                document.getElementById('paid').value = 0;
            } else if (paid > old) {
                payLimitHint.style.display = 'block';
                noDebtHint.style.display = 'none';
                submitBtn.disabled = true;
            } else {
                payLimitHint.style.display = 'none';
                noDebtHint.style.display = 'none';
                submitBtn.disabled = false;
            }
        } else {
            submitBtn.disabled = false;
            payLimitHint.style.display = 'none';
            noDebtHint.style.display = 'none';
        }
    }

    function saveData() {
        const name = document.getElementById('name').value.trim();
        const type = document.getElementById('opType').value;
        const remainVal = parseFloat(document.getElementById('remain').value);
        const oldVal = parseFloat(document.getElementById('oldDebt').value) || 0;
        const paidVal = parseFloat(document.getElementById('paid').value) || 0;

        if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ²Ø¹");
        
        // ØªØ£ÙƒÙŠØ¯ Ø­Ù…Ø§ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
        if (type === 'Ø¯ÙØ¹Ø©' && paidVal > oldVal) {
            return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¯ÙØ¹ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¯ÙŠÙ†!");
        }

        let finalTypeLabel = "";
        let cType = "";
        if (type === "Ø·Ø¨Ø¹Ø©") {
            finalTypeLabel = `Ø·Ø¨Ø¹Ø© (${document.getElementById('batch').value || 0})`;
            cType = document.getElementById('chickenType').value;
        } else {
            const userPayments = localDB.filter(r => r.name === name && r.type.includes("Ø¯ÙØ¹Ø©")).length;
            finalTypeLabel = `Ø¯ÙØ¹Ø© ${userPayments + 1}`;
            cType = "-";
        }

        const data = {
            name: name,
            type: finalTypeLabel,
            chickenType: cType,
            date: document.getElementById('opDate').value,
            batch: document.getElementById('batch').value || 0,
            qty: document.getElementById('qty').value,
            price: document.getElementById('price').value,
            old: Math.round(oldVal),
            paid: Math.round(paidVal),
            remain: Math.round(remainVal),
            ts: Date.now()
        };

        if (editingId) {
            database.child(editingId).update(data).then(() => { alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); resetForm(); });
        } else {
            database.push(data).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ…"); resetForm(); });
        }
    }

    function resetForm() {
        editingId = null;
        document.getElementById('submitBtn').innerText = "ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„";
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('cancelEdit').classList.add('hidden');
        document.getElementById('paid').value = 0;
        document.getElementById('qty').value = 0;
        document.getElementById('name').value = "";
        document.getElementById('oldDebt').value = 0;
        document.getElementById('remain').value = 0;
        document.getElementById('displayBal').innerText = 0;
        document.getElementById('opDate').valueAsDate = new Date();
        document.getElementById('payLimitHint').style.display = 'none';
        document.getElementById('noDebtHint').style.display = 'none';
    }

    function editItem(id) {
        const item = localDB.find(r => r.id === id);
        editingId = id;
        document.getElementById('name').value = item.name;
        document.getElementById('opType').value = item.type.includes("Ø·Ø¨Ø¹Ø©") ? "Ø·Ø¨Ø¹Ø©" : "Ø¯ÙØ¹Ø©";
        if(item.chickenType && item.chickenType !== "-") document.getElementById('chickenType').value = item.chickenType;
        document.getElementById('opDate').value = item.date;
        document.getElementById('batch').value = item.batch;
        document.getElementById('qty').value = item.qty;
        document.getElementById('price').value = item.price;
        document.getElementById('oldDebt').value = item.old;
        document.getElementById('paid').value = item.paid;
        document.getElementById('submitBtn').innerText = "ğŸ†™ ØªØ­Ø¯ÙŠØ«";
        document.getElementById('cancelEdit').classList.remove('hidden');
        toggleUI();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function deleteItem(id) {
        if (confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ")) database.child(id).remove();
    }

    function updateDatalist() {
        const namesList = document.getElementById('namesList');
        const uniqueNames = [...new Set(localDB.map(r => r.name))];
        namesList.innerHTML = uniqueNames.map(n => `<option value="${n}">`).join('');
    }

    function refreshUI() {
        const tbody = document.getElementById('mainTableBody');
        tbody.innerHTML = '';
        const filter = document.getElementById('filterName').value.trim();
        let displayData = filter ? localDB.filter(r => r.name.includes(filter)) : localDB;

        displayData.sort((a,b) => b.ts - a.ts).forEach(item => {
            const isBatch = item.type.includes("Ø·Ø¨Ø¹Ø©");
            tbody.innerHTML += `
                <tr class="${isBatch ? 'row-batch' : ''}">
                    <td style="font-weight:bold">${item.name}</td>
                    <td>${item.date}</td>
                    <td><span style="background:${isBatch?'#dcfce7':'#fef3c7'}; padding:4px 10px; border-radius:8px; font-size:0.8rem;">${item.type}</span></td>
                    <td style="font-weight:bold; color:#4f46e5;">${item.chickenType || '-'}</td>
                    <td>${item.qty}</td>
                    <td style="color:#64748b;">${item.old}</td> <td style="color:#059669; font-weight:bold;">${item.paid || 0}</td>
                    <td style="color:#e11d48; font-weight:bold;">${item.remain}</td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editItem('${item.id}')">âœï¸</button>
                        <button class="btn-action btn-del" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>`;
        });
    }
</script>
</body>
</html>
